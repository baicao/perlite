<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iframe Debug Final Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .iframe-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
            display: block;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 10;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Iframe 加载调试测试</h1>
        <p>这个页面用于调试iframe加载React应用时的ERR_ABORTED错误。</p>
        
        <button class="button" onclick="loadIframe()">加载 Iframe</button>
        <button class="button" onclick="clearLog()">清空日志</button>
        <button class="button" onclick="reloadIframe()">重新加载</button>
        
        <div class="log" id="log">
            <div>等待操作...</div>
        </div>
        
        <div class="iframe-container">
            <div class="loading" id="loading" style="display: none;">
                <div>正在加载编译器...</div>
                <div style="margin-top: 10px;">
                    <div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
            </div>
            <div id="iframe-placeholder" style="height: 600px; display: flex; align-items: center; justify-content: center; color: #666;">
                点击"加载 Iframe"按钮开始测试
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>
        let iframe = null;
        let loadingComplete = false;
        let startTime = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<div>日志已清空...</div>';
        }

        function loadIframe() {
            const container = document.querySelector('.iframe-container');
            const placeholder = document.getElementById('iframe-placeholder');
            const loading = document.getElementById('loading');
            
            // 重置状态
            loadingComplete = false;
            startTime = Date.now();
            
            // 移除现有iframe
            if (iframe) {
                iframe.remove();
                iframe = null;
            }
            
            // 显示加载状态
            placeholder.style.display = 'none';
            loading.style.display = 'block';
            
            log('开始创建iframe...');
            
            // 创建新iframe
            iframe = document.createElement('iframe');
            iframe.style.width = '100%';
            iframe.style.height = '600px';
            iframe.style.border = 'none';
            iframe.style.opacity = '0';
            iframe.style.transition = 'opacity 0.3s ease';
            
            // 监听iframe加载事件
            iframe.onload = function() {
                const loadTime = Date.now() - startTime;
                log(`Iframe onload 事件触发 (${loadTime}ms)`);
                
                // 检查iframe内容
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc) {
                        log('成功访问iframe文档');
                        const title = iframeDoc.title || '无标题';
                        log(`iframe文档标题: ${title}`);
                    }
                } catch (e) {
                    log(`无法访问iframe文档: ${e.message}`);
                }
                
                // 延迟显示iframe
                setTimeout(() => {
                    if (!loadingComplete) {
                        loadingComplete = true;
                        iframe.style.opacity = '1';
                        loading.style.display = 'none';
                        log('iframe显示完成');
                    }
                }, 1000);
            };
            
            iframe.onerror = function(e) {
                const loadTime = Date.now() - startTime;
                log(`Iframe onerror 事件触发 (${loadTime}ms): ${e.message || '未知错误'}`);
            };
            
            // 设置超时处理
            setTimeout(() => {
                if (!loadingComplete) {
                    const loadTime = Date.now() - startTime;
                    log(`超时处理触发 (${loadTime}ms) - 强制显示iframe`);
                    loadingComplete = true;
                    iframe.style.opacity = '1';
                    loading.style.display = 'none';
                }
            }, 8000);
            
            // 监听postMessage
            window.addEventListener('message', function(event) {
                if (event.source === iframe.contentWindow) {
                    const loadTime = Date.now() - startTime;
                    log(`收到iframe消息 (${loadTime}ms): ${JSON.stringify(event.data)}`);
                }
            });
            
            // 设置iframe源并添加到容器
            log('设置iframe src...');
            iframe.src = 'http://localhost:8080/pseudo_compiler/build/index.html';
            container.appendChild(iframe);
            
            log('iframe已添加到DOM');
        }

        function reloadIframe() {
            if (iframe) {
                log('重新加载iframe...');
                loadingComplete = false;
                startTime = Date.now();
                iframe.style.opacity = '0';
                document.getElementById('loading').style.display = 'block';
                iframe.src = iframe.src;
            } else {
                log('没有iframe可以重新加载');
            }
        }

        // 监听所有网络错误
        window.addEventListener('error', function(e) {
            if (e.target.tagName === 'IFRAME') {
                log(`iframe加载错误: ${e.message || '未知错误'}`);
            }
        }, true);

        log('调试页面初始化完成');
    </script>
</body>
</html>